
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>well</title><meta name="generator" content="MATLAB 7.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2012-05-21"><meta name="DC.source" content="well.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#3">If well is of class char then intepret it as the name of the spreadsheet</a></li><li><a href="#5">Check existance of header Nr, the wells must have a number</a></li><li><a href="#6">Using Nr, remove unwanted wells and possibly empty lines</a></li><li><a href="#7">See of rw is given</a></li><li><a href="#8">Generating the wells</a></li><li><a href="#9">Add well name and possible remark</a></li><li><a href="#11">Put wells in grid usingthe gridObj and the HK or TRAN array</a></li><li><a href="#12">Generating the input for the WEL package</a></li><li><a href="#13">THE COLUMNS IN THE PER SHEET REFERRING TO THE WELLS MUST BE NAMED Q_n where n is the well number!</a></li><li><a href="#14">Having verified all data columns are present we will add the data pertaining to each well to the well object itself.</a></li><li><a href="#15">Having thus ensured that every well carries its time flow data we are ready to generate the WEL array</a></li><li><a href="#16">At this point PNTSRC is required for the SSM package used by MT3DMS or SEAWAT</a></li><li><a href="#17">First thing is to know how many species (compoments) we deal with.</a></li><li><a href="#18">Find the columns in worksheet PER holding the concentrations for the well</a></li><li><a href="#19">Simultaneously compute the WEL array and the PNTSRC array</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> [well,WEL,PNTSRC]=well(gr,basename,HK,well)
</pre><pre class="codeinput"><span class="comment">% [well,WEL,PNTSRC]=gr.well(basename,HK,well_or_wellSheetName)</span>
<span class="comment">%</span>
<span class="comment">% GridObj.well sets this well into grid gr, where gr is of class gridObj.</span>
<span class="comment">%</span>
<span class="comment">% GridObj.well further ..</span>
<span class="comment">%   Looks for column Q_n with n=well number for Q(t) of this well.</span>
<span class="comment">%   Looks for column Cn_m with n=well number and m=species nr for</span>
<span class="comment">%   time-dependent injection concentration for this well.</span>
<span class="comment">%   The latter is only requested if PNTSRC is speciied as output.</span>
<span class="comment">% INPUT:</span>
<span class="comment">%   well_or_wellSheetName is either an array of wellObj or the name of the</span>
<span class="comment">%      worksheet in workbook basename where the pertinent data of the wells</span>
<span class="comment">%      are specified in a simple table.</span>
<span class="comment">%   HK is the 3D array of horizontal conductivities or transmissivities to</span>
<span class="comment">%      allow compuation of the fraction of the well flow to be attributed to</span>
<span class="comment">%      any cell penetrated by the well screen.</span>
<span class="comment">%   basename if the baasename of this problem used as the name or all files</span>
<span class="comment">%      generated by this problem and specified in mf_adapt.</span>
<span class="comment">%</span>
<span class="comment">% OUTPUT</span>
<span class="comment">%   well = array of wellObj instances according the the input or the</span>
<span class="comment">%      specification on sheet well of workbook &lt;&lt;basename&gt;&gt;.xls.</span>
<span class="comment">% WEL  = mfLab intput for the well package.</span>
<span class="comment">%    The well flows are looked up in the PER worksheet in the columns with</span>
<span class="comment">%    header Q_n where n is the well number as specified explicitly in the well</span>
<span class="comment">%    worksheet.</span>
<span class="comment">% PNTSRC = mfLab input for pointsources in SSM package of MT3DMS or SEAWAT.</span>
<span class="comment">%    To generate PNTSRC, the concentration for the stress periods for the wells</span>
<span class="comment">%    have to be specified as columns in the PER worksheet in &lt;&lt;basename&gt;&gt;.xls.</span>
<span class="comment">%    The headers of these columns are Cm_n where m is the well number and n the</span>
<span class="comment">%    species number.</span>
<span class="comment">%</span>
<span class="comment">%    If PNTSRC is required, the concentratons for each well must be specified</span>
<span class="comment">%    in columns of the PER sheet named C1_1 C2_1 C3_1 etc. for concentrations</span>
<span class="comment">%    of component 1, C1_2 C2_2 C3_2 for component two etc.</span>
<span class="comment">%</span>
<span class="comment">%    There must be no other names starting with C1_ C2_ etc in the PER worksheet.</span>
<span class="comment">%</span>
<span class="comment">% SEE ALSO: gridObj/setWell wellObj/WEl wellObj/PNTSRC mfSetWells</span>
<span class="comment">%</span>
<span class="comment">%   TO 110426 120103 120408</span>
<span class="comment">%</span>
<span class="comment">% Copyright 2009-2012 Theo Olsthoorn, TU-Delft and Waternet, without any warranty</span>
<span class="comment">% under free software foundation GNU license version 3 or later</span>
</pre><h2>If well is of class char then intepret it as the name of the spreadsheet<a name="3"></a></h2><p>In this situation the well objects are generated from scratch and immediately put in the grid.</p><pre class="codeinput"><span class="keyword">if</span> ischar(well_or_wellSheetName)
</pre><pre class="codeinput">    wellsheetname=well; clear <span class="string">well</span>;

    [welnams,welvals,weltxthdr,weltxt]=getExcelData(basename,wellsheetname,<span class="string">'hor'</span>);
</pre><h2>Check existance of header Nr, the wells must have a number<a name="5"></a></h2><p>The well numbers are specified by the user and not by the order they are specified in the worksheet. There is no necessity for well numbers ot be unique.</p><pre class="codeinput">    NrCol = strmatchi(<span class="string">'Nr'</span>,welnams,<span class="string">'exact'</span>);
    NrCol = NrCol(1);

    <span class="keyword">if</span> NrCol==0
        error(<span class="string">'mf_setwells:wellsheetname:NoWellNrs'</span>,<span class="keyword">...</span>
            <span class="string">'Header Nr missing in sheet &lt;&lt;%s&gt;&gt;!\n'</span>,wellsheetname);
    <span class="keyword">end</span>
</pre><h2>Using Nr, remove unwanted wells and possibly empty lines<a name="6"></a></h2><p>To allow easily switching wells on and off from the spreadsheet, set the unwanted well numbers to zero or their negative equivalent.</p><pre class="codeinput">    welvals=welvals(welvals(:,NrCol)&gt;0,:);

    <span class="keyword">if</span> isempty(welvals),
        error(<span class="string">'mfLab:mf_setwells:noActiveWells'</span>,<span class="keyword">...</span>
              <span class="string">'No active wells in sheet %s\n'</span>,wellsheetname);
    <span class="keyword">end</span>
</pre><h2>See of rw is given<a name="7"></a></h2><pre class="codeinput">    j=strmatchi(<span class="string">'diam'</span>,welnams);
    <span class="keyword">if</span>  j&gt;0,
        welnams{j}=<span class="string">'rw'</span>;
        welvals(:,j)=welvals(:,j)/2;
    <span class="keyword">end</span>
</pre><h2>Generating the wells<a name="8"></a></h2><p>we loop backward, so that the first cycle generates the well arrays in its entirety</p><pre class="codeinput">    NW = size(welvals,1);

    jNr = strmatchi(<span class="string">'Nr'</span>,welnams,<span class="string">'exact'</span>);
    jx  = strmatchi(<span class="string">'x'</span> ,welnams,<span class="string">'exact'</span>);
    jy  = strmatchi(<span class="string">'y'</span> ,welnams,<span class="string">'exact'</span>);
    jz  = strmatchi(<span class="string">'z'</span> ,welnams);
    jrw = strmatchi(<span class="string">'rw'</span>,welnams,<span class="string">'exact'</span>);

    <span class="keyword">for</span> iw=NW:-1:1
        well(iw) = wellObj( welvals(iw,jNr),<span class="keyword">...</span>
                            welvals(iw,jx),<span class="keyword">...</span>
                            welvals(iw,jy),<span class="keyword">...</span>
                            welvals(iw,jz)',<span class="keyword">...</span>
                            welvals(iw,jrw));
    <span class="keyword">end</span>
</pre><h2>Add well name and possible remark<a name="9"></a></h2><pre class="codeinput">    <span class="keyword">if</span> ~isempty(weltxthdr)
        j=strmatchi(<span class="string">'Name,'</span>,weltxthdr');
        <span class="keyword">if</span> j~=0
            <span class="keyword">for</span> iw=1:length(well)
                well(iw).name=weltxt{iw,j};
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        j=strmatchi(<span class="string">'Remark'</span>,weltxthdr');
        <span class="keyword">if</span> j~=0
            <span class="keyword">for</span> iw=1:length(well)
                well(iw).remark=weltxt{iw,j};
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">else</span>  <span class="comment">% check to see that the input is indeed of class wellObj</span>
    <span class="keyword">if</span> ~strcmpi(class(well),<span class="string">'wellObj'</span>)
        error(<span class="string">'mf_setwells:input:wellInput'</span>,<span class="keyword">...</span>
            <span class="string">'%s: input well|wellsheetname  must be either char or wellObj'</span>,mfilename);
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>Put wells in grid usingthe gridObj and the HK or TRAN array<a name="11"></a></h2><p>Putting the wells into the grid implies computing the grid coordinates for each well and other data that emerge when combining the real-world object well into the model grid that contains the information about the cells of the model and their coordinates. It will use HK (or TRAN) to compute the fraction extracted from each cell penetrated by the well screen. The output objects are equal to the input objects but with the grid information added.</p><pre class="codeinput"><span class="keyword">if</span> exist(<span class="string">'HK'</span>,<span class="string">'var'</span>)
    well=well.setWell(gr,HK);
<span class="keyword">end</span>

<span class="keyword">if</span> nargout&lt;2, <span class="keyword">return</span>; <span class="keyword">end</span>   <span class="comment">% no stress period data required</span>
</pre><h2>Generating the input for the WEL package<a name="12"></a></h2><p>the mfLab input for the WEL package is the same as the modflow input except that the first column is the stress period number to make the lines unique and to allow any order of the input in mfLab. mfLab will sort the output to match the modflow requirements.</p><pre class="codeinput">[pernams,pervals,NPER]=getPeriods(basename);
</pre><h2>THE COLUMNS IN THE PER SHEET REFERRING TO THE WELLS MUST BE NAMED Q_n where n is the well number!<a name="13"></a></h2><p>The first action is to verify that such a column exists for every well in the input. Note that different wells may have the same number. In that case they will get their flow data from the same column in the PER worksheet.</p><pre class="codeinput">QCOL=NaN(size(well));

<span class="keyword">for</span> iw=1:length(well)
    <span class="comment">% Geneate the names of the columns in the PER worksheet: Q_1, Q_2 Q_3 etc.</span>
    qstr=sprintf(<span class="string">'Q_%d'</span>,well(iw).nr);

    <span class="comment">% Look up the column number wit the time-flow datafor each wel in sequence</span>
    QCOL(iw)=strmatchi(qstr,pernams,<span class="string">'exact'</span>);

    <span class="comment">% If absent --&gt; error</span>
    <span class="keyword">if</span> QCOL(iw)==0
        error(<span class="string">'mf_setwells:QCol:PER'</span>,<span class="keyword">...</span>
            <span class="string">'No Q column &lt;&lt;%s&gt;&gt;in sheet PER for well Nr %d'</span>,qstr,well(iw).Nr);
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>Having verified all data columns are present we will add the data pertaining to each well to the well object itself.<a name="14"></a></h2><p>Hence each well will carry its own flow data for all stress periods. At the same time it carries the length of each stress period to allow computing total mass in or out of the well. Finally it carries the time of the end of the stress periods.</p><pre class="codeinput">Dt=pervals(:,strmatchi(<span class="string">'PERLEN'</span>,pernams));

<span class="keyword">for</span> iw=1:length(well)

    well(iw).Q  = pervals(:,QCOL(iw))'; <span class="comment">% as a horizontal vector for easy inspection</span>

<span class="comment">%     if any(isnan(well(iw).Q))</span>
<span class="comment">%         error('mf_setwells:pervals:QhasNaN',...</span>
<span class="comment">%             '%s.Q has NaN(s), check worksheet PER column &lt;&lt;Q_%d&gt;&gt; for missing Q data!\n',well(iw).name,well(iw).nr);</span>
<span class="comment">%     end</span>

    well(iw).Dt = Dt';

    <span class="comment">% set well t. Note that this may be overruled by setWelCout(well,C,iComp), using [C.time];</span>
    well(iw).t  = cumsum(well(iw).Dt,2);
<span class="keyword">end</span>
</pre><h2>Having thus ensured that every well carries its time flow data we are ready to generate the WEL array<a name="15"></a></h2><p>However, if nargout==3, so that also PNTSRC is requested, proceed generating PNTSRC and WEL simultaneously</p><pre class="codeinput"><span class="comment">% Only WEL required, PNTSRC not wanted</span>
<span class="keyword">if</span> nargout&lt;3,
    WEL=well.WEL;
    <span class="keyword">return</span>;
<span class="keyword">end</span>
</pre><h2>At this point PNTSRC is required for the SSM package used by MT3DMS or SEAWAT<a name="16"></a></h2><p>We will generate the PNTSRC and the WEL arrays jointly for efficiency.</p><h2>First thing is to know how many species (compoments) we deal with.<a name="17"></a></h2><p>For this we need the information form the MT3D worksheet. It contains the NCOMP and MCOMP parameter values. MCOMP is the total number of species in the simulation. The input must have this number of specified concentrations.</p><pre class="codeinput">[MT3nams,MT3vals]=getExcelData(basename,<span class="string">'MT3D'</span>,<span class="string">'vertical'</span>);
NCOMP=MT3vals(strmatchi(<span class="string">'NCOMP'</span>,MT3nams),1);

<span class="comment">%%%%% THE COLUMNS IN THE PER SHEET REFERRING TO CONCENTRATIONS MUST BE</span>
<span class="comment">%%%%% NAMED AS FOLLOWS  C%d_%d where the first %d is the well number and</span>
<span class="comment">%%%%% the second %d the species number: i.e.</span>
<span class="comment">%%%%% C1_1 C1_2 C1_3 C2_1 C2_2 C2_3 for three species and two wells</span>
</pre><h2>Find the columns in worksheet PER holding the concentrations for the well<a name="18"></a></h2><p>Whil looking for the respective columns in the PER worksheet. Add NCOMP to the well and allocate the required space to hold the input and the output concentrations of each well. The output concentrations can be set suing wellObj.setCout after the simulation with the computed concentrations available.</p><pre class="codeinput"><span class="keyword">for</span> iw=1:length(well)
    well(iw).NCOMP=NCOMP;
    well(iw).C = NaN(NCOMP,NPER);
<span class="comment">%    well(iw).Cout=NaN(size(well(iw).C)); % out conc for other application</span>

    <span class="keyword">for</span> iComp=1:NCOMP
        <span class="comment">% Column header Cm_n (m=wellNr, n=species nr)</span>
        cstr=sprintf(<span class="string">'C%d_%d'</span>,well(iw).nr,iComp);
        CCOL=strmatchi(cstr,pernams,<span class="string">'exact'</span>);
        <span class="keyword">if</span> iComp==1 &amp;&amp; CCOL==0
            <span class="comment">% if NCOMP==1 allow C_n with n well number</span>
            cstr=sprintf(<span class="string">'C_%d'</span>,well(iw).nr);
            CCOL=strmatchi(cstr,pernams,<span class="string">'exact'</span>);
            <span class="keyword">if</span> CCOL==0
                <span class="comment">% also allow Cn with n well number if NCOMP=1</span>
                cstr=sprintf(<span class="string">'C%d'</span>,well(iw).nr);
                CCOL=strmatchi(cstr,pernams,<span class="string">'exact'</span>);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> CCOL==0 <span class="comment">% However, the corresponding column in the PER sheet must exist !</span>
            error(<span class="string">'wellObj:well:CCOLnotfound'</span>,<span class="keyword">...</span>
                [<span class="string">'Can''t find well-concentration column header &lt;&lt;%s&gt;&gt;for component %d well %d in PER worksheet,\n'</span>,<span class="keyword">...</span>
                <span class="string">'Make sure your concentration column headings are "Ca_b" where a=species number and b=well number.\n'</span>,<span class="keyword">...</span>
                <span class="string">'Well number corresponds to the number in the sheet where you specified your wells including\n'</span>,<span class="keyword">...</span>
                <span class="string">'their well numbers. So the well number is specified by you independently of mfLab.\n'</span>],<span class="keyword">...</span>
                cstr,iComp,well(iw).nr);
        <span class="keyword">end</span>

        <span class="comment">% plug C into well object as a horizontal vector for each compoment for easy viewing</span>
        well(iw).C(iComp,:) =pervals(:,CCOL)';
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>Simultaneously compute the WEL array and the PNTSRC array<a name="19"></a></h2><p>At this point we have ensured that every well has both its flow data and its input concentration on board, se we can compute the mflab version of the the well package input WEL and the mflab version of the SSM package input PNTSRCR simultanously.</p><pre class="codeinput">[WEL,PNTSRC]=well.PNTSRC();
</pre><pre class="codeoutput">The class gridObj has no property or method named 'well'.
</pre><p class="footer"><br>
      Published with MATLAB&reg; 7.13<br></p></div><!--
##### SOURCE BEGIN #####
function [well,WEL,PNTSRC]=well(gr,basename,HK,well)
% [well,WEL,PNTSRC]=gr.well(basename,HK,well_or_wellSheetName)
%
% GridObj.well sets this well into grid gr, where gr is of class gridObj.
%
% GridObj.well further ..
%   Looks for column Q_n with n=well number for Q(t) of this well.
%   Looks for column Cn_m with n=well number and m=species nr for
%   time-dependent injection concentration for this well.
%   The latter is only requested if PNTSRC is speciied as output.
% INPUT:
%   well_or_wellSheetName is either an array of wellObj or the name of the
%      worksheet in workbook basename where the pertinent data of the wells
%      are specified in a simple table.
%   HK is the 3D array of horizontal conductivities or transmissivities to
%      allow compuation of the fraction of the well flow to be attributed to
%      any cell penetrated by the well screen.
%   basename if the baasename of this problem used as the name or all files
%      generated by this problem and specified in mf_adapt.
%
% OUTPUT
%   well = array of wellObj instances according the the input or the
%      specification on sheet well of workbook <<basename>>.xls.
% WEL  = mfLab intput for the well package.
%    The well flows are looked up in the PER worksheet in the columns with
%    header Q_n where n is the well number as specified explicitly in the well
%    worksheet.
% PNTSRC = mfLab input for pointsources in SSM package of MT3DMS or SEAWAT.
%    To generate PNTSRC, the concentration for the stress periods for the wells
%    have to be specified as columns in the PER worksheet in <<basename>>.xls.
%    The headers of these columns are Cm_n where m is the well number and n the
%    species number.
%
%    If PNTSRC is required, the concentratons for each well must be specified
%    in columns of the PER sheet named C1_1 C2_1 C3_1 etc. for concentrations
%    of component 1, C1_2 C2_2 C3_2 for component two etc.
%
%    There must be no other names starting with C1_ C2_ etc in the PER worksheet.
%
% SEE ALSO: gridObj/setWell wellObj/WEl wellObj/PNTSRC mfSetWells
%
%   TO 110426 120103 120408
%
% Copyright 2009-2012 Theo Olsthoorn, TU-Delft and Waternet, without any warranty
% under free software foundation GNU license version 3 or later


%% If well is of class char then intepret it as the name of the spreadsheet
% In this situation the well objects are generated from scratch and
% immediately put in the grid.

if ischar(well_or_wellSheetName)
    
    wellsheetname=well; clear well;

    [welnams,welvals,weltxthdr,weltxt]=getExcelData(basename,wellsheetname,'hor');

    %% Check existance of header Nr, the wells must have a number
    % The well numbers are specified by the user and not by the order they
    % are specified in the worksheet. There is no necessity for well
    % numbers ot be unique.
    
    NrCol = strmatchi('Nr',welnams,'exact');
    NrCol = NrCol(1);
    
    if NrCol==0
        error('mf_setwells:wellsheetname:NoWellNrs',...
            'Header Nr missing in sheet <<%s>>!\n',wellsheetname);
    end

    %% Using Nr, remove unwanted wells and possibly empty lines
    % To allow easily switching wells on and off from the spreadsheet, set
    % the unwanted well numbers to zero or their negative equivalent.

    welvals=welvals(welvals(:,NrCol)>0,:);

    if isempty(welvals),
        error('mfLab:mf_setwells:noActiveWells',...
              'No active wells in sheet %s\n',wellsheetname);
    end

    %% See of rw is given
    j=strmatchi('diam',welnams);
    if  j>0,
        welnams{j}='rw';
        welvals(:,j)=welvals(:,j)/2;
    end
 
    %% Generating the wells
    % we loop backward, so that the first cycle generates the well arrays
    % in its entirety
    
    NW = size(welvals,1);
    
    jNr = strmatchi('Nr',welnams,'exact');
    jx  = strmatchi('x' ,welnams,'exact');
    jy  = strmatchi('y' ,welnams,'exact');
    jz  = strmatchi('z' ,welnams);
    jrw = strmatchi('rw',welnams,'exact');
    
    for iw=NW:-1:1
        well(iw) = wellObj( welvals(iw,jNr),...
                            welvals(iw,jx),...
                            welvals(iw,jy),...
                            welvals(iw,jz)',...
                            welvals(iw,jrw));
    end
    
    %% Add well name and possible remark 
    if ~isempty(weltxthdr)
        j=strmatchi('Name,',weltxthdr');
        if j~=0
            for iw=1:length(well)
                well(iw).name=weltxt{iw,j};
            end
        end
        j=strmatchi('Remark',weltxthdr');
        if j~=0
            for iw=1:length(well)
                well(iw).remark=weltxt{iw,j};
            end
        end
    end
else  % check to see that the input is indeed of class wellObj
    if ~strcmpi(class(well),'wellObj')
        error('mf_setwells:input:wellInput',...
            '%s: input well|wellsheetname  must be either char or wellObj',mfilename);
    end
end

%% Put wells in grid usingthe gridObj and the HK or TRAN array
% Putting the wells into the grid implies computing the grid coordinates
% for each well and other data that emerge when combining the real-world
% object well into the model grid that contains the information about the
% cells of the model and their coordinates. It will use HK (or TRAN) to
% compute the fraction extracted from each cell penetrated by the well
% screen. The output objects are equal to the input objects but with the
% grid information added.

if exist('HK','var') 
    well=well.setWell(gr,HK);        
end

if nargout<2, return; end   % no stress period data required
    

%% Generating the input for the WEL package
% the mfLab input for the WEL package is the same as the modflow input
% except that the first column is the stress period number to make the
% lines unique and to allow any order of the input in mfLab. mfLab will
% sort the output to match the modflow requirements.

[pernams,pervals,NPER]=getPeriods(basename);

%% THE COLUMNS IN THE PER SHEET REFERRING TO THE WELLS MUST BE NAMED Q_n where n is the well number!
% The first action is to verify that such a column exists for every well in
% the input. Note that different wells may have the same number. In that
% case they will get their flow data from the same column in the PER
% worksheet.

QCOL=NaN(size(well));

for iw=1:length(well)
    % Geneate the names of the columns in the PER worksheet: Q_1, Q_2 Q_3 etc.
    qstr=sprintf('Q_%d',well(iw).nr);
    
    % Look up the column number wit the time-flow datafor each wel in sequence
    QCOL(iw)=strmatchi(qstr,pernams,'exact');
    
    % If absent REPLACE_WITH_DASH_DASH> error
    if QCOL(iw)==0
        error('mf_setwells:QCol:PER',...
            'No Q column <<%s>>in sheet PER for well Nr %d',qstr,well(iw).Nr);
    end
end

%% Having verified all data columns are present we will add the data pertaining to each well to the well object itself.
% Hence each well will carry its own flow data for all stress periods. At
% the same time it carries the length of each stress period to allow
% computing total mass in or out of the well. Finally it carries the time
% of the end of the stress periods.

Dt=pervals(:,strmatchi('PERLEN',pernams));

for iw=1:length(well)
    
    well(iw).Q  = pervals(:,QCOL(iw))'; % as a horizontal vector for easy inspection

%     if any(isnan(well(iw).Q))
%         error('mf_setwells:pervals:QhasNaN',...
%             '%s.Q has NaN(s), check worksheet PER column <<Q_%d>> for missing Q data!\n',well(iw).name,well(iw).nr);
%     end

    well(iw).Dt = Dt';
    
    % set well t. Note that this may be overruled by setWelCout(well,C,iComp), using [C.time];
    well(iw).t  = cumsum(well(iw).Dt,2);
end

%% Having thus ensured that every well carries its time flow data we are ready to generate the WEL array
% However, if nargout==3, so that also PNTSRC is requested, proceed
% generating PNTSRC and WEL simultaneously

% Only WEL required, PNTSRC not wanted
if nargout<3,
    WEL=well.WEL;
    return;
end

%% At this point PNTSRC is required for the SSM package used by MT3DMS or SEAWAT
% We will generate the PNTSRC and the WEL arrays jointly for efficiency.

%% First thing is to know how many species (compoments) we deal with.
% For this we need the information form the MT3D worksheet. It contains the
% NCOMP and MCOMP parameter values. MCOMP is the total number of species
% in the simulation. The input must have this number of specified
% concentrations.

[MT3nams,MT3vals]=getExcelData(basename,'MT3D','vertical');
NCOMP=MT3vals(strmatchi('NCOMP',MT3nams),1);

%%%%% THE COLUMNS IN THE PER SHEET REFERRING TO CONCENTRATIONS MUST BE
%%%%% NAMED AS FOLLOWS  C%d_%d where the first %d is the well number and
%%%%% the second %d the species number: i.e.
%%%%% C1_1 C1_2 C1_3 C2_1 C2_2 C2_3 for three species and two wells

%% Find the columns in worksheet PER holding the concentrations for the well
% Whil looking for the respective columns in the PER worksheet. Add NCOMP
% to the well and allocate the required space to hold the input and the
% output concentrations of each well.
% The output concentrations can be set suing wellObj.setCout after the simulation
% with the computed concentrations available.

for iw=1:length(well)
    well(iw).NCOMP=NCOMP;
    well(iw).C = NaN(NCOMP,NPER);
%    well(iw).Cout=NaN(size(well(iw).C)); % out conc for other application
 
    for iComp=1:NCOMP
        % Column header Cm_n (m=wellNr, n=species nr)
        cstr=sprintf('C%d_%d',well(iw).nr,iComp);
        CCOL=strmatchi(cstr,pernams,'exact');
        if iComp==1 && CCOL==0
            % if NCOMP==1 allow C_n with n well number
            cstr=sprintf('C_%d',well(iw).nr);
            CCOL=strmatchi(cstr,pernams,'exact');
            if CCOL==0
                % also allow Cn with n well number if NCOMP=1
                cstr=sprintf('C%d',well(iw).nr);
                CCOL=strmatchi(cstr,pernams,'exact');
            end
        end
        if CCOL==0 % However, the corresponding column in the PER sheet must exist !
            error('wellObj:well:CCOLnotfound',...
                ['Can''t find well-concentration column header <<%s>>for component %d well %d in PER worksheet,\n',...
                'Make sure your concentration column headings are "Ca_b" where a=species number and b=well number.\n',...
                'Well number corresponds to the number in the sheet where you specified your wells including\n',...
                'their well numbers. So the well number is specified by you independently of mfLab.\n'],...
                cstr,iComp,well(iw).nr);
        end
        
        % plug C into well object as a horizontal vector for each compoment for easy viewing
        well(iw).C(iComp,:) =pervals(:,CCOL)';
    end
end

%% Simultaneously compute the WEL array and the PNTSRC array
% At this point we have ensured that every well has both its flow data and
% its input concentration on board, se we can compute the mflab version of
% the the well package input WEL and the mflab version of the SSM package
% input PNTSRCR simultanously.

[WEL,PNTSRC]=well.PNTSRC();


##### SOURCE END #####
--></body></html>